<!DOCTYPE html>
<html>
<head>
	<title>Chess openings</title>
	<link rel="stylesheet" type="text/css" href="/css/chess_style.css">
	<script type="text/javascript" src="/js/vendor/signals.min.js"></script>
	<script type="text/javascript" src="/js/vendor/chess.js"></script>
	<script type="text/javascript" src="/js/vendor/easeljs-0.5.0.min.js"></script>
	<script type="text/javascript" src="/js/vendor/d3.v2.min.js"></script>
	<script type="text/javascript" src="/js/ChessOpenings.js"></script>
	<script type="text/javascript" src="/js/PGNSplitter.js"></script>
	<script type="text/javascript" src="/js/GameMetaData.js"></script>
	<script type="text/javascript" src="/js/ChessPlayback.js"></script>

	<script type="text/javascript" src="/generated_data/d3_openings_tree_extended.live.json"></script> <!--//var openings_tree = -->

	<script type="text/javascript">

	var linescale = 0.1;

	function go(){
		var mode = "all"
		if(window.location.hash != ""){
			mode = window.location.hash.substring(1);
		}
		console.log(mode);
		draw(mode); //Kramnik, Anand, Kramnic_and_Anand, Kramnik_vs_Anand
	}

	function draw(draw_option){
		var vis = d3.select("#d3_viz").append("svg:svg")
			.attr("width", 2000)
			.attr("height", 1000)
			.append("svg:g")
			.attr("transform", "translate(1000, 1000)");;

		var tree = d3.layout.tree()
			.size([1000,1000]);

/*		var link = d3.svg.diagonal()
			.projection( function(d){ return [d.x, 1000 - d.y]; } );*/

		var link = d3.svg.diagonal.radial()
			.projection(function(d) { 
				return [d.y, (d.x-500)/400]; });

		var nodes = tree.nodes(openings_tree.tree);
		//console.log(nodes); 
		var link = vis.selectAll("pathlink")
			.data(tree.links(nodes))
			.enter().append("svg:path")
			.attr("class", "link")
			.attr("stroke-width",function(d){
					//TODO look up the node weight and assign a thicness accordingly  ;
					var thickness = Math.log(openings_tree.lookup[d.target.name].weight);
					return thickness;
				})
			.attr("stroke",function(d){
					return getPlayerColour(openings_tree.lookup[d.target.name].players, draw_option);
				})
			.attr("stroke-opacity",function(d){ 
					return getOpacity(openings_tree.lookup[d.target.name].players, draw_option);
				})
			.attr("d", link)
			.on("mouseover", function(d){
				d3.select(".tooltip").style("visibility","visible");
			})
			.on("mousemove", function(d){
				d3.select(".tooltip").style("top", (event.pageY+10)+"px").style("left",(event.pageX+10)+"px")
					.html(getTipText(d));
			})
			.on("mouseout", function(d){
				d3.select(".tooltip").style("visibility", "hidden");
			});
	}

	function getTipText(d){
		var fen = openings_tree.lookup[d.target.name].fen
		var c = new Chess(openings_tree.lookup[d.target.name].fen)
		return('<pre>' + c.ascii() + '</pre><p>' + openings_tree.lookup[d.target.name].opening_groups + '</p><p>'+openings_tree.lookup[d.target.name].opening_ending+'</p>')
	}

	function getPlayerColour(players, draw_option){
		if(players){
			if(players[draw_option]){
				return "#DDDDDD";
			}
		}
		return "#666666";
	}

	function getOpacity(players, draw_option){
		if(players){
			if(players[draw_option]){
				return 1;
			}
		}
		return 0.5;
	}

	function getECOColour(ECO_codes){
		console.log(ECO_codes);
		colours = {
			A:"#FF85FF",
			B:"#0096FF",
			C:"#8EFA00",
			D:"#FF9300",
			E:"#531B93"
		}
		return colours[ECO_codes[0]];
	}


	</script>
	<style type="text/css">
		.label{
			border-bottom: solid;
			border-width: 1px;
			border-color: #fff;
			position: absolute;
			color: #fff;
		}

		.link {
			fill: none;
			//stroke: #000;
			//stroke-width: 1px;
		}


	</style>
</head>
<body onLoad="go()">
<h1>Chess openings</h1>
<div class="description">
<p><b>Chess openings</b> </p>
<div class="description">a tree diagram showing the ~2500 recognised openings and how they're related</div>
</div>
<div class='tooltip'>
	tooltip
</div>
<div id="options"></div>
<div id="extra">
</div>
<div class="visualisation" id="d3_viz">
</div>


</body>
</html>